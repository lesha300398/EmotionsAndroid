package lesha300398.emotions

import io.reactivex.Observable
import io.reactivex.schedulers.Schedulers
import org.jtransforms.fft.DoubleFFT_1D
import kotlin.math.*

class Spectrogram {

    private lateinit var window: DoubleArray

    companion object {
        private const val FFT_SIZE = 2048
        private const val HOP = 431
    }


    fun spectrogram(data: ShortArray): Array<DoubleArray> {
        if (!::window.isInitialized) {
            buildWindow()
        }

        val dataPadded = reflectPadding(data)

        val result = Array<DoubleArray>(ceil(data.size.toFloat() / HOP).toInt()) { DoubleArray(mels.size) }

        var max_val = Double.NEGATIVE_INFINITY
        Observable.fromIterable(result.indices)
            .observeOn(Schedulers.computation())
            .doOnNext { i ->
                var currInput = ShortArray(FFT_SIZE)

                System.arraycopy(dataPadded, i * HOP, currInput, 0, currInput.size)
                val windowedInput = applyWindow(currInput)

                val a = DoubleArray((FFT_SIZE) * 2)
                val fft = DoubleFFT_1D(FFT_SIZE.toLong())

                System.arraycopy(windowedInput, 0, a, 0 ,windowedInput.size)

                fft.realForward(a)

                val melSpectr = result[i]

                for (iMel in melSpectr.indices) {
                    for (entry in mels[iMel].entries) {
                        melSpectr[iMel] += entry.value * (a[entry.key*2] * a[entry.key*2] + a[entry.key*2 + 1]*a[entry.key*2 + 1])
                    }
                    if (melSpectr[iMel] > max_val) {
                        max_val = melSpectr[iMel]
                    }
                }
            }
            .ignoreElements()
            .blockingAwait()


        for (frame in result) {
            for (i in frame.indices)
                if(frame[i] <= 0) {
                    frame[i] = -80.0
                } else {
                    frame[i] = max(10* log10(frame[i] / max_val), -80.0)
                }
        }
        return result
    }

    private fun buildWindow() {
        window = DoubleArray(FFT_SIZE)
        for (i in 0 until FFT_SIZE) {
            window[i] = .54 - .46 * cos(2.0 * Math.PI * i.toDouble() / (FFT_SIZE - 1.0))
        }
    }
    private fun applyWindow(input: ShortArray): DoubleArray {
        val result = DoubleArray(input.size)

        for (i in input.indices) {
            result[i] = input[i].toDouble() * window[i]
        }
        return result
    }

    private fun reflectPadding(input: ShortArray): ShortArray {
        val out = ShortArray(input.size + FFT_SIZE - (input.size % HOP))
        System.arraycopy(input, 0, out, FFT_SIZE / 2, input.size)
        var idx = 0
        for (i in FFT_SIZE /2 - 1 downTo 0) {
            out[i] = input[idx]
            idx++
        }
        idx = input.size + FFT_SIZE / 2 - 1
        for (i in input.size + FFT_SIZE / 2 until out.size) {
            out[i] = out[idx]
            idx--
        }
        return out
//        if(input.size == FFT_SIZE) return input
//
//        val out = ShortArray(FFT_SIZE)
//        System.arraycopy(input, 0, out, 0, input.size)
//        var filled = input.size
//        while (filled < out.size) {
//            var offset = 1
//            for (i in filled until min(out.size, 2 * filled)) {
//                out[i] = out[input.size - 1 - offset]
//                offset++
//            }
//            filled += input.size - 1
//        }
    }



    private val mels = listOf(
        mapOf(1 to 0.04504320397973060608),
        mapOf(1 to 0.00945045426487922668, 2 to 0.03559274971485137939),
        mapOf(2 to 0.01890090852975845337, 3 to 0.02614229544997215271),
        mapOf(3 to 0.02835136279463768005, 4 to 0.01669184118509292603),
        mapOf(4 to 0.03780181705951690674, 5 to 0.00724138692021369934),
        mapOf(5 to 0.04725227132439613342),
        mapOf(6 to 0.05228459089994430542),
        mapOf(6 to 0.00220906757749617100, 7 to 0.04283413663506507874),
        mapOf(7 to 0.01165952160954475403, 8 to 0.03338368237018585205),
        mapOf(8 to 0.02110997587442398071, 9 to 0.02393322810530662537),
        mapOf(9 to 0.03056043013930320740, 10 to 0.01448277384042739868),
        mapOf(10 to 0.04001088440418243408, 11 to 0.00503231910988688469),
        mapOf(11 to 0.04946134239435195923),
        mapOf(12 to 0.05007552355527877808),
        mapOf(12 to 0.00441813515499234200, 13 to 0.04062506929039955139),
        mapOf(13 to 0.01386858895421028137, 14 to 0.03117461316287517548),
        mapOf(14 to 0.02331904321908950806, 15 to 0.02172415889799594879),
        mapOf(15 to 0.03276949748396873474, 16 to 0.01227370556443929672),
        mapOf(16 to 0.04221995174884796143, 17 to 0.00282325129956007004),
        mapOf(17 to 0.05167040601372718811),
        mapOf(18 to 0.04786645621061325073),
        mapOf(18 to 0.00662720296531915665, 19 to 0.03841600194573402405),
        mapOf(19 to 0.01607765629887580872, 20 to 0.02896554768085479736),
        mapOf(20 to 0.02552811242640018463, 21 to 0.01951509155333042145),
        mapOf(21 to 0.03497856482863426208, 22 to 0.01006463821977376938),
        mapOf(22 to 0.04442901909351348877, 23 to 0.00061418372206389904),
        mapOf(23 to 0.05387947335839271545),
        mapOf(24 to 0.04565738514065742493),
        mapOf(24 to 0.00883627030998468399, 25 to 0.03620693460106849670),
        mapOf(25 to 0.01828672550618648529, 26 to 0.02675647847354412079),
        mapOf(26 to 0.02773717790842056274, 27 to 0.01730602607131004333),
        mapOf(27 to 0.03718763589859008789, 28 to 0.00785557087510824203),
        mapOf(28 to 0.04663808643817901611),
        mapOf(29 to 0.05289877578616142273),
        mapOf(29 to 0.00159488397184759378, 30 to 0.04344831779599189758),
        mapOf(30 to 0.01104533858597278595, 31 to 0.03399786725640296936),
        mapOf(31 to 0.02049579285085201263, 32 to 0.02454741112887859344),
        mapOf(32 to 0.02994624525308609009, 33 to 0.01509695779532194138),
        mapOf(33 to 0.03939670324325561523, 34 to 0.00564650259912014008),
        mapOf(34 to 0.04884715750813484192),
        mapOf(35 to 0.05068970844149589539),
        mapOf(35 to 0.00380395143292844296, 36 to 0.04123925045132637024),
        mapOf(36 to 0.01325440593063831329, 37 to 0.03178879618644714355),
        mapOf(37 to 0.02270486019551753998, 38 to 0.02233834378421306610),
        mapOf(38 to 0.03215531259775161743, 39 to 0.01288788951933383942),
        mapOf(39 to 0.04160577058792114258, 40 to 0.00343743502162396908),
        mapOf(40 to 0.05105622485280036926),
        mapOf(41 to 0.04848064109683036804),
        mapOf(41 to 0.00601301947608590126, 42 to 0.03903018310666084290),
        mapOf(42 to 0.01546347327530384064, 43 to 0.02957973070442676544),
        mapOf(43 to 0.02491392754018306732, 44 to 0.02012927643954753876),
        mapOf(44 to 0.03436437994241714478, 45 to 0.01067882124334573746),
        mapOf(45 to 0.04381483420729637146, 46 to 0.00122836744412779808),
        mapOf(46 to 0.05278111621737480164),
        mapOf(47 to 0.04602400958538055420),
        mapOf(47 to 0.00647503742948174477, 48 to 0.03913608938455581665),
        mapOf(48 to 0.01198771689087152481, 49 to 0.03390876203775405884),
        mapOf(49 to 0.01617239415645599365, 50 to 0.02994269877672195435),
        mapOf(50 to 0.01913716457784175873, 51 to 0.02713403850793838501),
        mapOf(51 to 0.02098360657691955566, 52 to 0.02538522332906723022),
        mapOf(52 to 0.02180712483823299408, 53 to 0.02460466697812080383),
        mapOf(53 to 0.02169726416468620300, 54 to 0.02470644004642963409),
        mapOf(54 to 0.02073803730309009552, 55 to 0.02560996264219284058),
        mapOf(55 to 0.01900819875299930573, 56 to 0.02723972871899604797),
        mapOf(56 to 0.01658153720200061798, 57 to 0.02952503412961959839),
        mapOf(57 to 0.01352714188396930695, 58 to 0.03239971026778221130),
        mapOf(58 to 0.00990964192897081375, 59 to 0.03580189123749732971),
        mapOf(59 to 0.00578946433961391449, 60 to 0.03967376798391342163, 61 to 0.00395521614700555801),
        mapOf(60 to 0.00122305168770253658, 61 to 0.03627199679613113403, 62 to 0.00956948474049568176),
        mapOf(62 to 0.03001024015247821808, 63 to 0.01549987588077783585),
        mapOf(63 to 0.02345239557325839996, 64 to 0.02170131355524063110),
        mapOf(64 to 0.01664243452250957489, 65 to 0.02813189104199409485),
        mapOf(65 to 0.00962121319025754929, 66 to 0.03475270420312881470, 67 to 0.00519267283380031586),
        mapOf(66 to 0.00242665666155517101, 67 to 0.03143253549933433533, 68 to 0.01306555606424808502),
        mapOf(68 to 0.02302246168255805969, 69 to 0.02101838588714599609),
        mapOf(69 to 0.01454677991569042206, 70 to 0.02902176789939403534, 71 to 0.00263467757031321526),
        mapOf(70 to 0.00603409018367528915, 71 to 0.03192650899291038513, 72 to 0.01164159551262855530),
        mapOf(72 to 0.02244145609438419342, 73 to 0.02061066403985023499),
        mapOf(73 to 0.01300567574799060822, 74 to 0.02952036447823047638, 75 to 0.00596563378348946571),
        mapOf(74 to 0.00364004774019122124, 75 to 0.02675320394337177277, 76 to 0.01567120105028152466),
        mapOf(76 to 0.01661830954253673553, 77 to 0.02524738386273384094, 78 to 0.00340990186668932438),
        mapOf(77 to 0.00662183249369263649, 78 to 0.02804993279278278351, 79 to 0.01365276891738176346),
        mapOf(79 to 0.01741051487624645233, 80 to 0.02370758540928363800, 81 to 0.00346215744502842426),
        mapOf(80 to 0.00696665467694401741, 81 to 0.02683254703879356384, 82 to 0.01406989526003599167),
        mapOf(82 to 0.01585695892572402954, 83 to 0.02444095723330974579, 84 to 0.00567151326686143875),
        mapOf(83 to 0.00512423506006598473, 84 to 0.02354180999100208282, 85 to 0.01649555750191211700),
        mapOf(85 to 0.01237502135336399078, 86 to 0.02704315446317195892, 87 to 0.00964209064841270447),
        mapOf(86 to 0.00148972438182681799, 87 to 0.01856457255780696869, 88 to 0.02055511996150016785, 89 to 0.00380036816932260990),
        mapOf(88 to 0.00733073474839329720, 89 to 0.02377138845622539520, 90 to 0.01502728182822465897),
        mapOf(90 to 0.01223939750343561172, 91 to 0.02592085115611553192, 92 to 0.01038759853690862656),
        mapOf(91 to 0.00104416662361472845, 92 to 0.01628622040152549744, 93 to 0.02152455225586891174, 94 to 0.00656823720782995224),
        mapOf(93 to 0.00486165191978216171, 94 to 0.01953758485615253448, 95 to 0.01790616102516651154, 96 to 0.00350535521283745766),
        mapOf(95 to 0.00792511831969022751, 96 to 0.02205595560371875763, 97 to 0.01500482577830553055, 98 to 0.00113889540079981089),
        mapOf(97 to 0.01029410306364297867, 98 to 0.02390009351074695587, 99 to 0.01276331022381782532),
        mapOf(99 to 0.01202459726482629776, 100 to 0.02398285269737243652, 101 to 0.01112781371921300888),
        mapOf(100 to 0.00055517820874229074, 101 to 0.01316922809928655624, 102 to 0.02242535725235939026, 103 to 0.01004777941852807999),
        mapOf(102 to 0.00163189682643860579, 103 to 0.01377743389457464218, 104 to 0.02139358595013618469, 105 to 0.00947573781013488770),
        mapOf(104 to 0.00220121024176478386, 105 to 0.01389563642442226410, 106 to 0.02084233239293098450, 107 to 0.00936713721603155136),
        mapOf(106 to 0.00230732350610196590, 107 to 0.01356739550828933716, 108 to 0.02072916738688945770, 109 to 0.00968018732964992523),
        mapOf(108 to 0.00199170853011310101, 109 to 0.01283355802297592163, 110 to 0.02101431787014007568, 111 to 0.01037571765482425690),
        mapOf(110 to 0.00129324756562709808, 111 to 0.01173240784555673599, 112 to 0.02166049554944038391, 113 to 0.01141703687608242035, 114 to 0.00117357715498656034),
        mapOf(112 to 0.00024837261298671365, 113 to 0.01029980089515447617, 114 to 0.02035122923552989960, 115 to 0.01276979781687259674, 116 to 0.00290680048055946827),
        mapOf(115 to 0.00856929272413253784, 116 to 0.01824739016592502594, 117 to 0.01440186891704797745, 118 to 0.00490520475432276726),
        mapOf(117 to 0.00657226564362645149, 118 to 0.01589089818298816681, 119 to 0.01628322340548038483, 120 to 0.00713928509503602982),
        mapOf(119 to 0.00433804467320442200, 120 to 0.01331056375056505203, 121 to 0.01838581450283527374, 122 to 0.00958150066435337067, 123 to 0.00077718758257105947),
        mapOf(121 to 0.00189401127863675356, 122 to 0.01053327135741710663, 123 to 0.01917253434658050537, 124 to 0.01220616884529590607, 125 to 0.00372886680997908115),
        mapOf(124 to 0.00758408801630139351, 125 to 0.01590246893465518951, 126 to 0.01498936209827661514, 127 to 0.00682692416012287140),
        mapOf(126 to 0.00448635779321193695, 127 to 0.01249577663838863373, 128 to 0.01790880784392356873, 129 to 0.01004953961819410324, 130 to 0.00219027162529528141),
        mapOf(128 to 0.00126180367078632116, 129 to 0.00897373631596565247, 130 to 0.01668566837906837463, 131 to 0.01337644085288047791, 132 to 0.00580908218398690224),
        mapOf(131 to 0.00535611016675829887, 132 to 0.01278160512447357178, 133 to 0.01678881607949733734, 134 to 0.00950252544134855270, 135 to 0.00221623387187719345),
        mapOf(133 to 0.00166123243980109692, 134 to 0.00881092902272939682, 135 to 0.01596062630414962769, 136 to 0.01325356774032115936, 137 to 0.00623790454119443893),
        mapOf(136 to 0.00479022832587361336, 137 to 0.01167436968535184860, 138 to 0.01704646274447441101, 139 to 0.01029137708246707916, 140 to 0.00353628979064524174),
        mapOf(138 to 0.00073483196320012212, 139 to 0.00736328307539224625, 140 to 0.01399173401296138763, 141 to 0.01436248607933521271, 142 to 0.00785829592496156693, 143 to 0.00135410763323307037),
        mapOf(141 to 0.00304114352911710739, 142 to 0.00942340027540922165, 143 to 0.01580565609037876129, 144 to 0.01217558234930038452, 145 to 0.00591297214850783348),
        mapOf(144 to 0.00486583542078733444, 145 to 0.01101104076951742172, 146 to 0.01647651381790637970, 147 to 0.01044651027768850327, 148 to 0.00441650627180933952),
        mapOf(146 to 0.00033033994259312749, 147 to 0.00624730065464973450, 148 to 0.01216426026076078415, 149 to 0.01494440343230962753, 150 to 0.00913836713880300522, 151 to 0.00333233107812702656),
        mapOf(149 to 0.00152444362174719572, 150 to 0.00722163589671254158, 151 to 0.01291882805526256561, 152 to 0.01380686182528734207, 153 to 0.00821647327393293381, 154 to 0.00262608542107045650),
        mapOf(152 to 0.00233717518858611584, 153 to 0.00782276224344968796, 154 to 0.01330834813416004181, 155 to 0.01303100120276212692, 156 to 0.00764825101941823959, 157 to 0.00226550176739692688),
        mapOf(155 to 0.00280069536529481411, 156 to 0.00808253511786460876, 157 to 0.01336437650024890900, 158 to 0.01258593983948230743, 159 to 0.00740311713889241219, 160 to 0.00222029397264122963),
        mapOf(158 to 0.00294519891031086445, 159 to 0.00803086068481206894, 160 to 0.01311652269214391708, 161 to 0.01244269870221614838, 162 to 0.00745237711817026138, 163 to 0.00246205483563244343),
        mapOf(161 to 0.00279901945032179356, 162 to 0.00769578944891691208, 163 to 0.01259255874902009964, 164 to 0.01257409527897834778, 165 to 0.00776912504807114601, 166 to 0.00296415365301072598),
        mapOf(164 to 0.00238872598856687546, 165 to 0.00710361916571855545, 166 to 0.01181851327419281006, 167 to 0.01295465230941772461, 168 to 0.00832814816385507584, 169 to 0.00370164308696985245),
        mapOf(167 to 0.00173921824898570776, 168 to 0.00627899123355746269, 169 to 0.01081876363605260849, 170 to 0.01356050278991460800, 171 to 0.00910583604127168655, 172 to 0.00465116975829005241, 173 to 0.00019650299509521574),
        mapOf(170 to 0.00087381596677005291, 171 to 0.00524497171863913536, 172 to 0.00961612816900014877, 173 to 0.01398728415369987488, 174 to 0.01008009724318981171, 175 to 0.00579088553786277771, 176 to 0.00150167464744299650),
        mapOf(174 to 0.00402314448729157448, 175 to 0.00823194719851016998, 176 to 0.01244074944406747818, 177 to 0.01123027037829160690, 178 to 0.00710036978125572205, 179 to 0.00297046918421983719),
        mapOf(177 to 0.00263368501327931881, 178 to 0.00668616360053420067, 179 to 0.01073864195495843887, 180 to 0.01253705658018589020, 181 to 0.00856054853647947311, 182 to 0.00458404142409563065, 183 to 0.00060753384605050087),
        mapOf(180 to 0.00109543954022228718, 181 to 0.00499740056693553925, 182 to 0.00889936089515686035, 183 to 0.01280132215470075607, 184 to 0.01015362422913312912, 185 to 0.00632481230422854424, 186 to 0.00249600037932395935),
        mapOf(184 to 0.00318303145468235016, 185 to 0.00694006588310003281, 186 to 0.01069709938019514084, 187 to 0.01186299975961446762, 188 to 0.00817639846354722977, 189 to 0.00448979623615741730, 190 to 0.00080319435801357031)
        )
}